name: Sync Master LFS

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # ref: master
          lfs: false

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Sync MSU â†’ GitHub
        run: |
      - name: Calculate Missing Objects
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
      - name: Calculate Missing Objects
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 -c '
          import sys, json, os, subprocess, urllib.request
          
          # 1. Get local LFS files and sizes
          objects, obj_map = [], {}
          try: output = subprocess.check_output(["git", "lfs", "ls-files", "-l"], text=True)
          except: sys.exit(0)
          
          for line in output.splitlines():
              parts = line.strip().split()
              if len(parts) < 3: continue
              oid, path = parts[0], " ".join(parts[2:])
              obj_map.setdefault(oid, []).append(path)
              
              if not any(o["oid"] == oid for o in objects) and os.path.exists(path):
                  with open(path) as f:
                      size = next((int(l.split()[1]) for l in f if l.startswith("size ")), 0)
                  objects.append({"oid": oid, "size": size})

          # 2. Query GitHub API in batches
          missing = []
          url = "https://github.com/" + os.environ["GITHUB_REPOSITORY"] + ".git/info/lfs/objects/batch"
          headers = {
              "Accept": "application/vnd.git-lfs+json",
              "Content-Type": "application/vnd.git-lfs+json",
              "Authorization": "Bearer " + os.environ["GITHUB_TOKEN"]
          }

          for i in range(0, len(objects), 50):
              data = json.dumps({"operation": "download", "transfers": ["basic"], "objects": objects[i:i+50]}).encode()
              resp = json.load(urllib.request.urlopen(urllib.request.Request(url, data, headers)))
              
              for obj in resp.get("objects", []):
                  if "error" in obj or "download" not in obj.get("actions", {}):
                      oid = obj["oid"]
                      missing.append(oid)
                      for p in obj_map.get(oid, []): print("Missing: " + p)

          with open("missing.txt", "w") as f: f.write("\n".join(missing))
          '

      - name: Show Missing Files
        run: |
          if [ ! -s missing.txt ]; then
            echo "GitHub is already up to date!"
            exit 0
          fi
          
          echo "Found $(wc -l < missing.txt | xargs) objects missing on GitHub:"
          git lfs ls-files -l > lfs_map.txt
          
          while read oid; do
            filename=$(grep "^$oid" lfs_map.txt | awk '{print $3}')
            echo "$filename ($oid)"
          done < missing.txt

      - name: Fetch from MSU
        run: |
          if [ ! -s missing.txt ]; then exit 0; fi
          
          git config lfs.url https://tardis:tardis-2025-lfs@registry.moria.egr.msu.edu/repository/tardis-lfs/info/lfs
          
          # Reuse lfs_map.txt
          [ ! -f lfs_map.txt ] && git lfs ls-files -l > lfs_map.txt
          
          while read oid; do 
            filename=$(grep "^$oid" lfs_map.txt | awk '{print $3}')
            if [ -n "$filename" ]; then
               echo "Fetching $filename"
               git lfs fetch origin --include="$filename"
            fi
          done < missing.txt

      # - name: Push to GitHub
      #   run: |
      #     if [ ! -s missing.txt ]; then exit 0; fi
          
      #     git config lfs.url https://github.com/${{ github.repository }}.git/info/lfs
          
      #     echo "Pushing $(wc -l < missing.txt | xargs) objects to GitHub..."
      #     git lfs push origin master