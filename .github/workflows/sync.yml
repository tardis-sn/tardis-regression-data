name: Sync Master LFS

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # ref: master
          lfs: false

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Sync MSU â†’ GitHub
        run: |
      - name: Calculate Missing Objects
        run: |
          # Create batch request using Python for robust parsing
          python3 -c '
          import sys, json, os, subprocess
          
          try:
              output = subprocess.check_output(["git", "lfs", "ls-files", "-l"], text=True)
          except subprocess.CalledProcessError:
              sys.exit(0)
              
          objects = []
          for line in output.splitlines():
              parts = line.strip().split()
              if len(parts) < 3: continue
              oid = parts[0]
              path = " ".join(parts[2:])
              
              if os.path.exists(path):
                  with open(path, "r") as f:
                      # Read size from pointer file
                      for l in f:
                          if l.startswith("size "):
                              objects.append({"oid": oid, "size": int(l.split()[1])})
                              break
          
          if not objects:
              print("No LFS objects found", file=sys.stderr)
          
          print(json.dumps({"operation": "download", "transfers": ["basic"], "objects": objects}))
          ' > batch.json
          
          echo "=== DEBUG: batch.json content ==="
          cat batch.json
          echo "================================="
          
          if [ "$(jq '.objects | length' batch.json)" -eq 0 ]; then
             echo "No LFS objects found in repository."
             touch missing.txt
             exit 0
          fi
          
          # Query GitHub to see what is already there
          echo "Querying GitHub LFS API..."
          curl -v -X POST https://github.com/${{ github.repository }}.git/info/lfs/objects/batch \
            -H "Content-Type: application/vnd.git-lfs+json" \
            -H "Accept: application/vnd.git-lfs+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -d @batch.json > response.json 2> curl_debug.log || true
            
          echo "=== DEBUG: curl stderr ==="
          cat curl_debug.log
          echo "=== DEBUG: GitHub API Response ==="
          cat response.json
          echo "=================================="
          
          if grep -q "Not Found" response.json || grep -q "404" response.json; then
             echo "Error: GitHub LFS API returned 404. Check repository URL and permissions."
             exit 1
          fi
          
          jq -r '.objects[] | select(.error or (.actions.download == null)) | .oid' response.json > missing.txt

      - name: Show Missing Files
        run: |
          if [ ! -s missing.txt ]; then
            echo "GitHub is already up to date!"
            exit 0
          fi
          
          echo "Found $(wc -l < missing.txt | xargs) objects missing on GitHub:"
          git lfs ls-files -l > lfs_map.txt
          
          while read oid; do
            filename=$(grep "^$oid" lfs_map.txt | awk '{print $3}')
            echo "$filename ($oid)"
          done < missing.txt

      - name: Fetch from MSU
        run: |
          if [ ! -s missing.txt ]; then exit 0; fi
          
          git config lfs.url https://tardis:tardis-2025-lfs@registry.moria.egr.msu.edu/repository/tardis-lfs/info/lfs
          
          # Reuse lfs_map.txt
          [ ! -f lfs_map.txt ] && git lfs ls-files -l > lfs_map.txt
          
          while read oid; do 
            filename=$(grep "^$oid" lfs_map.txt | awk '{print $3}')
            if [ -n "$filename" ]; then
               echo "Fetching $filename"
               git lfs fetch origin --include="$filename"
            fi
          done < missing.txt

      # - name: Push to GitHub
      #   run: |
      #     if [ ! -s missing.txt ]; then exit 0; fi
          
      #     git config lfs.url https://github.com/${{ github.repository }}.git/info/lfs
          
      #     echo "Pushing $(wc -l < missing.txt | xargs) objects to GitHub..."
      #     git lfs push origin master